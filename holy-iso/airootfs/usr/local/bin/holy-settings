#!/usr/bin/env bash
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘   EIGHT.ONE OS â€” Holy Settings Menu       â•‘
# â•‘   A premium TUI settings experience       â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

GOLD="\e[33m"
WHITE="\e[97m"
CYAN="\e[36m"
DIM="\e[2m"
BOLD="\e[1m"
RESET="\e[0m"

show_header() {
    clear
    echo -e "${GOLD}${BOLD}"
    figlet -f small "8.1 Settings" 2>/dev/null || echo "â•â•â• 8.1 SETTINGS â•â•â•"
    echo -e "${RESET}${DIM}EIGHT.ONE OS Â· Infinity One Â· $(date +%Y.%m.%d)${RESET}"
    echo ""
}

# â”€â”€â”€ System Update â”€â”€â”€
do_update() {
    show_header
    echo -e "${GOLD}âŸ System Update${RESET}\n"
    gum confirm "Update all system packages?" && {
        echo -e "${CYAN}Updating keyring...${RESET}"
        sudo pacman -Sy --noconfirm archlinux-keyring 2>/dev/null
        echo -e "${CYAN}Updating packages...${RESET}"
        sudo pacman -Syu --noconfirm
        echo -e "\n${GOLD}âœ“ Update complete!${RESET}"
    }
    echo ""
    gum input --placeholder "Press Enter to continue..."
}

# â”€â”€â”€ Install Software â”€â”€â”€
do_install() {
    show_header
    echo -e "${GOLD}âŸ Install Software${RESET}\n"
    
    CHOICE=$(gum choose \
        "ğŸ” Search Packages" \
        "ğŸ“ Code Editors" \
        "ğŸŒ Browsers" \
        "ğŸ® Gaming" \
        "ğŸ“¦ Install from AUR (yay)" \
        "â† Back")
    
    case "$CHOICE" in
        *"Search Packages"*)
            PKG=$(gum input --placeholder "Enter package name to search...")
            [ -n "$PKG" ] && pacman -Ss "$PKG" | head -40
            gum input --placeholder "Press Enter to continue..."
            ;;
        *"Code Editors"*)
            EDITOR=$(gum choose "neovim (installed)" "code (VSCode)" "zed" "helix" "sublime-text" "â† Back")
            case "$EDITOR" in
                *code*) sudo pacman -S --noconfirm code 2>/dev/null || echo "Use AUR for VSCode" ;;
                *zed*) sudo pacman -S --noconfirm zed 2>/dev/null || echo "Use AUR for Zed" ;;
                *helix*) sudo pacman -S --noconfirm helix ;;
            esac
            gum input --placeholder "Press Enter to continue..."
            ;;
        *"Browsers"*)
            BROWSER=$(gum choose "firefox" "chromium" "brave (AUR)" "â† Back")
            case "$BROWSER" in
                *firefox*) sudo pacman -S --noconfirm firefox ;;
                *chromium*) sudo pacman -S --noconfirm chromium ;;
            esac
            gum input --placeholder "Press Enter to continue..."
            ;;
        *"Gaming"*)
            GAME=$(gum choose "steam" "lutris" "mangohud" "gamemode" "â† Back")
            [ "$GAME" != "â† Back" ] && sudo pacman -S --noconfirm "$GAME" 2>/dev/null
            gum input --placeholder "Press Enter to continue..."
            ;;
    esac
}

# â”€â”€â”€ Display & Monitors â”€â”€â”€
do_display() {
    show_header
    echo -e "${GOLD}âŸ Display Settings${RESET}\n"
    
    echo -e "${CYAN}Current monitors:${RESET}"
    hyprctl monitors 2>/dev/null || echo "Hyprland not running"
    echo ""
    
    CHOICE=$(gum choose \
        "ğŸ–¥ï¸  Set Resolution" \
        "ğŸ“ Set Scale" \
        "ğŸ”„ Set Refresh Rate" \
        "â† Back")
    
    case "$CHOICE" in
        *"Resolution"*)
            MON=$(hyprctl monitors -j 2>/dev/null | jq -r '.[].name' | gum choose)
            RES=$(gum input --placeholder "e.g. 1920x1080")
            [ -n "$MON" ] && [ -n "$RES" ] && hyprctl keyword monitor "$MON,$RES,auto,1"
            ;;
        *"Scale"*)
            SCALE=$(gum choose "1.0" "1.25" "1.5" "1.75" "2.0")
            MON=$(hyprctl monitors -j 2>/dev/null | jq -r '.[].name' | head -1)
            [ -n "$MON" ] && hyprctl keyword monitor "$MON,preferred,auto,$SCALE"
            ;;
        *"Refresh Rate"*)
            RATE=$(gum choose "60" "75" "120" "144" "165" "240")
            MON=$(hyprctl monitors -j 2>/dev/null | jq -r '.[].name' | head -1)
            [ -n "$MON" ] && hyprctl keyword monitor "$MON,preferred@${RATE},auto,1"
            ;;
    esac
    gum input --placeholder "Press Enter to continue..."
}

# â”€â”€â”€ Network â”€â”€â”€
do_network() {
    show_header
    echo -e "${GOLD}âŸ Network & Connectivity${RESET}\n"
    
    CHOICE=$(gum choose \
        "ğŸ“¶ WiFi Manager" \
        "ğŸ”µ Bluetooth Manager" \
        "ğŸ–¥ï¸  Display Manager" \
        "ğŸŒ IP Address" \
        "ğŸ” DNS Test" \
        "â† Back")
    
    case "$CHOICE" in
        *"WiFi"*)       holy-wifi ;;
        *"Bluetooth"*)  holy-bluetooth ;;
        *"Display"*)    holy-display ;;
        *"IP Address"*)
            ip -c addr show | grep -E "inet |link/"
            gum input --placeholder "Press Enter to continue..."
            ;;
        *"DNS"*)
            echo -e "${CYAN}Testing DNS resolution...${RESET}"
            ping -c 3 archlinux.org 2>/dev/null || echo "No network connection"
            gum input --placeholder "Press Enter to continue..."
            ;;
    esac
}

# â”€â”€â”€ Keyboard & Language â”€â”€â”€
do_keyboard() {
    show_header
    echo -e "${GOLD}âŸ Keyboard & Language${RESET}\n"
    
    echo -e "${CYAN}Current layout:${RESET} $(localectl status 2>/dev/null | grep 'X11 Layout' || cat /etc/vconsole.conf 2>/dev/null)"
    echo ""
    
    LAYOUT=$(gum choose "us" "de" "gb" "fr" "es" "it" "pt" "ru" "jp" "â† Back")
    
    if [ "$LAYOUT" != "â† Back" ]; then
        echo "KEYMAP=$LAYOUT" | sudo tee /etc/vconsole.conf > /dev/null
        # Update Hyprland live
        hyprctl keyword input:kb_layout "$LAYOUT" 2>/dev/null
        echo -e "${GOLD}âœ“ Keyboard set to: $LAYOUT${RESET}"
    fi
    gum input --placeholder "Press Enter to continue..."
}

# â”€â”€â”€ Appearance â”€â”€â”€
do_appearance() {
    show_header
    echo -e "${GOLD}âŸ Appearance${RESET}\n"
    
    CHOICE=$(gum choose \
        "ğŸ¨ Border Color" \
        "ğŸ“ Gap Size" \
        "ğŸ”² Border Width" \
        "ğŸŒŠ Rounding" \
        "âœ¨ Animations Toggle" \
        "â† Back")
    
    case "$CHOICE" in
        *"Border Color"*)
            COLOR=$(gum choose \
                "Gold (d4af37)" \
                "Cyan (00ffff)" \
                "Purple (9b59b6)" \
                "Red (e74c3c)" \
                "Green (2ecc71)" \
                "White (ffffff)")
            HEX=$(echo "$COLOR" | grep -oP '\(.*?\)' | tr -d '()')
            [ -n "$HEX" ] && hyprctl keyword general:col.active_border "rgba(${HEX}ee)" 2>/dev/null
            ;;
        *"Gap Size"*)
            GAP=$(gum choose "0" "3" "5" "8" "10" "15" "20")
            hyprctl keyword general:gaps_out "$GAP" 2>/dev/null
            hyprctl keyword general:gaps_in "$((GAP/2))" 2>/dev/null
            ;;
        *"Border Width"*)
            WIDTH=$(gum choose "1" "2" "3" "4" "5")
            hyprctl keyword general:border_size "$WIDTH" 2>/dev/null
            ;;
        *"Rounding"*)
            ROUND=$(gum choose "0" "5" "8" "10" "15" "20")
            hyprctl keyword decoration:rounding "$ROUND" 2>/dev/null
            ;;
        *"Animations"*)
            gum confirm "Enable animations?" \
                && hyprctl keyword animations:enabled 1 2>/dev/null \
                || hyprctl keyword animations:enabled 0 2>/dev/null
            ;;
    esac
    echo -e "${GOLD}âœ“ Applied!${RESET}"
    gum input --placeholder "Press Enter to continue..."
}

# â”€â”€â”€ Tools Launcher â”€â”€â”€
do_tools() {
    show_header
    echo -e "${GOLD}âŸ Developer Tools${RESET}\n"
    
    TOOL=$(gum choose \
        "ğŸ“Š System Monitor (btop)" \
        "ğŸ“ File Manager (yazi)" \
        "ğŸ”€ Git TUI (lazygit)" \
        "ğŸ³ Docker TUI (lazydocker)" \
        "ğŸ“ Editor (neovim)" \
        "ğŸ¤– AI Assistant (ollama)" \
        "ğŸ”‘ SSH Key Manager" \
        "ğŸ“‹ Clipboard Manager" \
        "ğŸ¬ Screen Recorder" \
        "â„¹ï¸  System Info (fastfetch)" \
        "â† Back")
    
    case "$TOOL" in
        *btop*) btop ;;
        *yazi*) yazi ;;
        *lazygit*) lazygit ;;
        *lazydocker*) lazydocker ;;
        *neovim*) nvim ;;
        *"SSH Key"*) holy-ssh ;;
        *"Clipboard"*) holy-clip ;;
        *"Screen Recorder"*) holy-record ;;
        *ollama*)
            echo -e "${CYAN}Starting Ollama...${RESET}"
            sudo systemctl start ollama 2>/dev/null
            sleep 2
            gum confirm "Pull qwen2.5-coder:1.5b model?" && ollama pull qwen2.5-coder:1.5b
            echo -e "${GOLD}Run: ollama run qwen2.5-coder:1.5b${RESET}"
            gum input --placeholder "Press Enter to continue..."
            ;;
        *fastfetch*) fastfetch; gum input --placeholder "Press Enter..." ;;
    esac
}

# â”€â”€â”€ System â”€â”€â”€
do_system() {
    show_header
    echo -e "${GOLD}âŸ System${RESET}\n"
    
    CHOICE=$(gum choose \
        "ğŸ‘¤ Change Password" \
        "ğŸ”§ Hostname" \
        "â° Timezone" \
        "ğŸ’¾ Disk Usage" \
        "ğŸ”Œ Systemd Services" \
        "â† Back")
    
    case "$CHOICE" in
        *"Password"*) passwd ;;
        *"Hostname"*)
            NEW=$(gum input --placeholder "Enter new hostname..." --value "$(hostname)")
            [ -n "$NEW" ] && sudo hostnamectl set-hostname "$NEW" 2>/dev/null
            echo -e "${GOLD}âœ“ Hostname: $NEW${RESET}"
            ;;
        *"Timezone"*)
            ZONE=$(timedatectl list-timezones | gum filter --placeholder "Search timezone...")
            [ -n "$ZONE" ] && sudo timedatectl set-timezone "$ZONE"
            echo -e "${GOLD}âœ“ Timezone: $ZONE${RESET}"
            ;;
        *"Disk"*)
            df -h --type=ext4 --type=btrfs --type=xfs --type=vfat 2>/dev/null || df -h
            ;;
        *"Services"*)
            SVC=$(systemctl list-units --type=service --state=running --no-legend | awk '{print $1}' | gum filter --placeholder "Search service...")
            [ -n "$SVC" ] && systemctl status "$SVC" --no-pager
            ;;
    esac
    echo ""
    gum input --placeholder "Press Enter to continue..."
}

# â”€â”€â”€ About â”€â”€â”€
do_about() {
    show_header
    fastfetch
    echo ""
    echo -e "${GOLD}${BOLD}EIGHT.ONE OS Â· Infinity One${RESET}"
    echo -e "${DIM}A Holy Developer Environment${RESET}"
    echo -e "${DIM}Built on Arch Linux Â· Hyprland WM${RESET}"
    echo -e "${DIM}âœ Soli Deo Gloria âœ${RESET}"
    echo ""
    gum input --placeholder "Press Enter to continue..."
}

# â•â•â• Main Menu Loop â•â•â•
while true; do
    show_header
    
    CHOICE=$(gum choose \
        --cursor.foreground "#d4af37" \
        --item.foreground "#ffffff" \
        --header.foreground "#d4af37" \
        --header "  âœ  Holy Settings  âœ" \
        "ğŸ”„  System OS Update (Git)" \
        "ğŸ“¦  Install Software" \
        "ğŸ–¥ï¸   Display & Monitors" \
        "ğŸ“¶  Network & Connectivity" \
        "âŒ¨ï¸   Keyboard & Language" \
        "ğŸ¨  Appearance" \
        "ğŸ› ï¸   Developer Tools" \
        "âš™ï¸   System" \
        "â„¹ï¸   About" \
        "âŒ  Exit")
    
    case "$CHOICE" in
        *"OS Update"*)  eightone-update ;;
        *"Install"*)    do_install ;;
        *"Display"*)    do_display ;;
        *"Network"*)    do_network ;;
        *"Keyboard"*)   do_keyboard ;;
        *"Appearance"*) do_appearance ;;
        *"Developer"*)  do_tools ;;
        *"System"*)     do_system ;;
        *"About"*)      do_about ;;
        *"Exit"*|"")    clear; break ;;
    esac
done
