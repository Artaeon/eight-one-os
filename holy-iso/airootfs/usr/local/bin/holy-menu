#!/usr/bin/env bash
# EIGHT.ONE OS — Command Palette (OmArchy Style)
# Central command menu — access every tool and action from one place
# Triggered via Alt+Super+Space

set -euo pipefail

# ── fuzzel configuration ──
FUZZEL_OPTS=(
    --dmenu
    --prompt="  "
    --width=45
    --lines=20
    --horizontal-pad=20
    --vertical-pad=12
    --inner-pad=8
    --border-width=2
    --border-radius=12
    --border-color=d4af37ff
    --background=0a0a0fee
    --text-color=e8e6dfff
    --match-color=d4af37ff
    --selection-color=d4af3733
    --selection-text-color=d4af37ff
    --font="JetBrainsMono Nerd Font:size=12"
)

# ── Categories ──
CATEGORIES=(
    "Apps"
    "Learn"
    "Trigger"
    "Style"
    "Setup"
    "Install"
    "Remove"
    "Update"
    "About"
    "System"
)

# Show main category menu
SELECTED_CATEGORY=$(printf "%s\n" "${CATEGORIES[@]}" | fuzzel "${FUZZEL_OPTS[@]}")

[ -z "$SELECTED_CATEGORY" ] && exit 0

# ── Actions based on category ──
case "$SELECTED_CATEGORY" in
    "Apps")
        declare -A ACTIONS=(
            ["Terminal"]="kitty"
            ["Browser"]="holy-browser"
            ["IDE"]="holy-ide"
            ["Files"]="kitty -e yazi"
            ["Obsidian"]="obsidian"
        )
        ;;
    "Learn")
        declare -A ACTIONS=(
            ["Bible"]="kitty -e holy-bible"
            ["Dashboard"]="kitty --title 'Holy Dash' -e holy-dash"
        )
        ;;
    "Trigger")
        declare -A ACTIONS=(
            ["Flow Timer"]="kitty -e holy-flow tui"
            ["Focus Mode"]="kitty -e holy-focus builder"
            ["AI Assistant"]="kitty --title 'Holy AI' -e holy-ai"
            ["Voice Dictation"]="holy-dictate toggle"
        )
        ;;
    "Style")
        declare -A ACTIONS=(
            ["Settings"]="kitty -e holy-settings"
            ["Vibes"]="kitty -e holy-vibes"
        )
        ;;
    "Setup")
        declare -A ACTIONS=(
            ["WiFi"]="kitty -e holy-wifi"
            ["Bluetooth"]="kitty -e holy-bluetooth"
            ["Display"]="kitty -e holy-display"
            ["SSH Keys"]="kitty -e holy-ssh"
            ["Dev Tools"]="kitty --title 'Holy Dev' -e holy-dev"
        )
        ;;
    "Install")
        declare -A ACTIONS=(
            ["AUR Package"]="kitty -e holy-aur"
            ["Flatpak Package"]="kitty -e bash -c 'flatpak search \"\$(gum input --placeholder \"Search Flatpak...\")\" && read'"
        )
        ;;
    "Remove")
        declare -A ACTIONS=(
            ["Pacman Package"]="kitty -e bash -c 'sudo pacman -Rns \$(pacman -Qq | gum filter) && read'"
            ["Flatpak Package"]="kitty -e bash -c 'flatpak uninstall \$(flatpak list --app --columns=application | gum filter) && read'"
        )
        ;;
    "Update")
        declare -A ACTIONS=(
            ["System Update"]="kitty --hold -e eightone-update"
        )
        ;;
    "About")
        declare -A ACTIONS=(
            ["System Info"]="kitty --hold -e fastfetch"
        )
        ;;
    "System")
        declare -A ACTIONS=(
            ["System Monitor"]="kitty -e btop"
            ["Disk Usage"]="kitty -e dust"
            ["Processes"]="kitty -e procs"
            ["Record Screen"]="holy-record toggle"
            ["Notifications"]="kitty -e holy-notify"
            ["Clipboard"]="cliphist list | fuzzel --dmenu | cliphist decode | wl-copy"
            ["Windows VM"]="kitty --title 'Holy Windows' -e holy-windows"
            ["Lock Screen"]="hyprlock"
            ["Suspend"]="systemctl suspend"
            ["Reboot"]="systemctl reboot"
            ["Shutdown"]="systemctl poweroff"
            ["Logout"]="hyprctl dispatch exit"
        )
        ;;
    *)
        exit 0
        ;;
esac

# Build items list
ITEMS=""
for item in "${!ACTIONS[@]}"; do
    ITEMS+="${item}\n"
done

# Show second level menu
SELECTED_ACTION=$(echo -e "$ITEMS" | sort | fuzzel "${FUZZEL_OPTS[@]}" --prompt="  $SELECTED_CATEGORY ❯ ")

[ -z "$SELECTED_ACTION" ] && exit 0

# Execute selected action
CMD="${ACTIONS[$SELECTED_ACTION]}"
if [ -n "$CMD" ]; then
    eval "exec $CMD" &
fi

