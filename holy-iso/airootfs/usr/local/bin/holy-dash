#!/usr/bin/env bash
# EIGHT.ONE OS â€” Holy Dash
# Builder's master dashboard â€” weather, agenda, tasks, and projects
# Usage: holy-dash

GOLD="\e[33m"
CYAN="\e[36m"
GREEN="\e[32m"
RED="\e[31m"
DIM="\e[2m"
BOLD="\e[1m"
RESET="\e[0m"

PROJECTS_DIR="$HOME/Projects"
VAULT_DIR="$HOME/Vault"

clear
echo -e "${GOLD}${BOLD}"
figlet -f small "Holy Dash" 2>/dev/null || echo "â•â•â• HOLY DASH â•â•â•"
echo -e "${RESET}${DIM}Let all things be done decently and in order.${RESET}\n"

# --- 1. Top Section Overview ---
echo -e "${CYAN}â”€â”€ Insight â”€â”€${RESET}\n"

# Weather
# Only fetch if connected to internet
if ping -c 1 8.8.8.8 >/dev/null 2>&1; then
    WEATHER=$(curl -s "wttr.in/?format=3" 2>/dev/null || echo "Weather unavailable")
    echo -e "${BOLD}Condition:${RESET} $WEATHER"
else
    echo -e "${BOLD}Condition:${RESET} Offline"
fi

# Next Event
if command -v khal >/dev/null 2>&1; then
    AGENDA=$(khal list today tomorrow 2>/dev/null | head -n 3 | grep -v 'No events' || echo "  No immediate events.")
    echo -e "${BOLD}Agenda:${RESET}\n$AGENDA"
else
    echo -e "${BOLD}Agenda:${RESET} Khal not configured."
fi

# Open Tasks
OPEN_TASKS=$(grep -rn "^\s*- \[ \]" "$VAULT_DIR" 2>/dev/null | wc -l || true)
echo -e "${BOLD}Open Tasks:${RESET} $OPEN_TASKS outstanding\n"

# --- 2. Projects Section ---
echo -e "${CYAN}â”€â”€ Projects â”€â”€${RESET}\n"

# Gather all git repos
repos=()
while IFS= read -r gitdir; do
    repo_dir=$(dirname "$gitdir")
    repos+=("$repo_dir")
done < <(find "$PROJECTS_DIR" -maxdepth 4 -name ".git" -type d 2>/dev/null | sort)

if [ ${#repos[@]} -eq 0 ]; then
    echo -e "${DIM}No git projects found in $PROJECTS_DIR${RESET}"
    echo -e "Start building! Use ${CYAN}holy-dev${RESET} to scaffold a new project."
    echo ""
    gum input --placeholder "Press Enter..."
    exit 0
fi

# Build display list
display_items=()
repo_map=()

for repo in "${repos[@]}"; do
    local_name="${repo#$PROJECTS_DIR/}"

    # Get git status
    cd "$repo" 2>/dev/null || continue
    branch=$(git branch --show-current 2>/dev/null || echo "detached")

    dirty=""
    staged=$(git diff --cached --numstat 2>/dev/null | wc -l)
    unstaged=$(git diff --numstat 2>/dev/null | wc -l)
    untracked=$(git ls-files --others --exclude-standard 2>/dev/null | wc -l)

    if [ "$staged" -gt 0 ]; then dirty="${dirty}+${staged} "; fi
    if [ "$unstaged" -gt 0 ]; then dirty="${dirty}~${unstaged} "; fi
    if [ "$untracked" -gt 0 ]; then dirty="${dirty}?${untracked} "; fi
    [ -z "$dirty" ] && dirty="âœ“ clean"

    last_commit=$(git log -1 --format="%ar" 2>/dev/null || echo "no commits")
    
    lang=""
    [ -f "Cargo.toml" ] && lang="ğŸ¦€"
    [ -f "package.json" ] && lang="ğŸ“¦"
    [ -f "go.mod" ] && lang="ğŸ¹"
    { [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; } && lang="ğŸ"
    [ -f "Makefile" ] && [ -z "$lang" ] && lang="âš™ï¸"
    [ -z "$lang" ] && lang="ğŸ“"

    display_items+=("$lang $local_name [$branch] $dirty â€” $last_commit")
    repo_map+=("$repo")
done

cd "$HOME" || exit

SELECTED=$(printf '%s\n' "${display_items[@]}" | gum choose --height 12)

if [ -z "$SELECTED" ]; then
    exit 0
fi

# Find the selected repo
idx=0
selected_repo=""
for item in "${display_items[@]}"; do
    if [ "$item" = "$SELECTED" ]; then
        selected_repo="${repo_map[$idx]}"
        break
    fi
    idx=$((idx + 1))
done

if [ -z "$selected_repo" ]; then
    exit 0
fi

# Action menu
echo -e "\n${GOLD}$SELECTED${RESET}\n"

ACTION=$(gum choose \
    "ğŸ“‚ Open in Neovim" \
    "ğŸ“œ View git log" \
    "ğŸ“Š Git status" \
    "ğŸš Open shell here" \
    "â† Back")

case "$ACTION" in
    *"Neovim"*) cd "$selected_repo" && exec nvim . ;;
    *"git log"*) cd "$selected_repo" && git log --oneline -20 | gum pager ;;
    *"status"*) cd "$selected_repo" && git status | gum pager ;;
    *"shell"*)
        echo -e "${CYAN}Opening shell in $selected_repo${RESET}"
        echo -e "${DIM}Type 'exit' to return.${RESET}\n"
        cd "$selected_repo" && exec "$SHELL"
        ;;
esac
