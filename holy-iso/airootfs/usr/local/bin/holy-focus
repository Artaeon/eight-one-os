#!/usr/bin/env bash
# EIGHT.ONE OS â€” Holy Focus
# A distraction blocker with Builder Mode â€” the nuclear option for productivity.
# Usage: holy-focus [activate|deactivate|builder|status]

CYAN="\e[36m"
GOLD="\e[33m"
RED="\e[31m"
GREEN="\e[32m"
BOLD="\e[1m"
DIM="\e[2m"
RESET="\e[0m"

DISTRACTIONS=(
    "twitter.com" "www.twitter.com" "x.com" "www.x.com"
    "facebook.com" "www.facebook.com"
    "instagram.com" "www.instagram.com"
    "reddit.com" "www.reddit.com"
    "tiktok.com" "www.tiktok.com"
    "youtube.com" "www.youtube.com"
    "netflix.com" "www.netflix.com"
    "twitch.tv" "www.twitch.tv"
    "discord.com" "www.discord.com"
)

BUILDER_STATE="$HOME/.local/share/holy-flow/builder_mode"
mkdir -p "$HOME/.local/share/holy-flow"

is_focus_active() {
    grep -q "holy-focus-block" /etc/hosts 2>/dev/null
}

is_builder_mode() {
    [ -f "$BUILDER_STATE" ] && [ "$(cat "$BUILDER_STATE")" = "active" ]
}

activate_focus() {
    echo -e "${CYAN}Muting notifications...${RESET}"
    makoctl mode -s dnd 2>/dev/null

    echo -e "${CYAN}Blocking distracting websites...${RESET}"
    for site in "${DISTRACTIONS[@]}"; do
        echo "127.0.0.1 $site # holy-focus-block" | sudo tee -a /etc/hosts > /dev/null
        echo "::1 $site # holy-focus-block" | sudo tee -a /etc/hosts > /dev/null
    done
}

deactivate_focus() {
    echo -e "${CYAN}Restoring notifications...${RESET}"
    makoctl mode -r dnd 2>/dev/null

    echo -e "${CYAN}Unblocking websites...${RESET}"
    sudo sed -i '/# holy-focus-block/d' /etc/hosts
}

activate_builder_mode() {
    echo -e "\n${GOLD}${BOLD}âš¡ BUILDER MODE âš¡${RESET}\n"
    echo -e "${DIM}Terminal + Editor only. Everything else will be closed.${RESET}\n"

    if ! gum confirm "This will close all browsers, media apps, and chat apps. Continue?"; then
        return
    fi

    # Activate focus first
    if ! is_focus_active; then
        activate_focus
    fi

    # Kill non-essential apps
    echo -e "${CYAN}Closing non-essential apps...${RESET}"
    local kill_apps=("chromium" "firefox" "brave" "obsidian" "spotify" "discord" "telegram-desktop" "slack" "thunderbird" "mpv" "vlc" "libreoffice")
    for app in "${kill_apps[@]}"; do
        pkill -f "$app" 2>/dev/null
    done

    # Start flow timer automatically
    holy-flow start 2>/dev/null

    echo "active" > "$BUILDER_STATE"
    echo -e "\n${GOLD}${BOLD}ðŸ—ï¸ Builder Mode ACTIVE${RESET}"
    echo -e "Only your terminal and Neovim remain."
    echo -e "${DIM}Run 'holy-focus' to deactivate when done.${RESET}\n"
}

deactivate_builder_mode() {
    echo "inactive" > "$BUILDER_STATE"
    holy-flow stop 2>/dev/null
}

# --- TUI ---

show_tui() {
    clear
    echo -e "${GOLD}${BOLD}"
    figlet -f small "Holy Focus" 2>/dev/null || echo "â•â•â• HOLY FOCUS â•â•â•"
    echo -e "${RESET}${DIM}Protecting your time and attention.${RESET}\n"

    # Show status
    if is_builder_mode; then
        echo -e "Status: ${RED}${BOLD}âš¡ BUILDER MODE${RESET} (hardcore)\n"
    elif is_focus_active; then
        echo -e "Status: ${GOLD}ðŸ›¡ï¸ FOCUS ACTIVE${RESET} (sites blocked, notifications muted)\n"
    else
        echo -e "Status: ${GREEN}INACTIVE${RESET}\n"
    fi

    # Menu
    if is_builder_mode; then
        CHOICE=$(gum choose \
            "ðŸ”“ Deactivate Builder Mode" \
            "ðŸ“Š View Flow Status" \
            "â† Back")
        case "$CHOICE" in
            *"Deactivate"*)
                deactivate_builder_mode
                deactivate_focus
                echo -e "\n${GREEN}âœ“ Builder Mode deactivated. Welcome back.${RESET}"
                ;;
            *"Flow"*)
                holy-flow status
                ;;
        esac
    elif is_focus_active; then
        CHOICE=$(gum choose \
            "ðŸ”“ Deactivate Focus" \
            "âš¡ Upgrade to Builder Mode" \
            "â† Back")
        case "$CHOICE" in
            *"Deactivate"*)
                deactivate_focus
                echo -e "\n${GREEN}âœ“ Focus Mode deactivated.${RESET}"
                ;;
            *"Builder"*)
                activate_builder_mode
                ;;
        esac
    else
        CHOICE=$(gum choose \
            "ðŸ›¡ï¸ Activate Focus (Block Sites + Mute)" \
            "âš¡ Activate Builder Mode (Nuclear Option)" \
            "ðŸ”• Mute Notifications Only" \
            "â† Back")
        case "$CHOICE" in
            *"Focus"*)
                activate_focus
                echo -e "\n${GOLD}âœ“ Focus Mode activated.${RESET}"
                echo -e "Run ${CYAN}holy-focus${RESET} again to deactivate."
                ;;
            *"Builder"*)
                activate_builder_mode
                ;;
            *"Mute"*)
                makoctl mode -s dnd 2>/dev/null
                echo -e "${GOLD}âœ“ Notifications silenced.${RESET}"
                ;;
        esac
    fi

    echo ""
    gum input --placeholder "Press Enter to exit..."
    clear
}

# --- Main ---

case "${1:-}" in
    activate) activate_focus ;;
    deactivate) deactivate_focus ;;
    builder) activate_builder_mode ;;
    status)
        if is_builder_mode; then echo "builder"
        elif is_focus_active; then echo "focus"
        else echo "inactive"
        fi
        ;;
    *) show_tui ;;
esac
