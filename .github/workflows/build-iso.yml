name: Build EIGHT.ONE OS ISO

on:
  push:
    branches: [main]
    paths:
      - 'holy-iso/**'
  workflow_dispatch:
    inputs:
      release:
        description: 'Create a GitHub Release with the ISO'
        required: false
        default: true
        type: boolean

# Only run one build at a time
concurrency:
  group: iso-build
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Install build dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm archiso git zstd

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache pacman packages
        uses: actions/cache@v4
        with:
          path: /var/cache/pacman/pkg
          key: pacman-${{ hashFiles('holy-iso/packages.x86_64') }}
          restore-keys: pacman-

      - name: Build ISO
        run: |
          cd holy-iso
          mkarchiso -v -w /tmp/archiso-work -o /tmp/archiso-out .

      - name: Get ISO info
        id: iso
        run: |
          ISO_FILE=$(ls /tmp/archiso-out/*.iso)
          ISO_NAME=$(basename "$ISO_FILE")
          ISO_SIZE=$(stat --printf="%s" "$ISO_FILE")
          echo "path=$ISO_FILE" >> "$GITHUB_OUTPUT"
          echo "name=$ISO_NAME" >> "$GITHUB_OUTPUT"
          echo "size=$ISO_SIZE" >> "$GITHUB_OUTPUT"
          echo "date=$(date +%Y.%m.%d)" >> "$GITHUB_OUTPUT"
          sha256sum "$ISO_FILE" > "/tmp/archiso-out/${ISO_NAME}.sha256"
          echo "ISO size: $(du -h "$ISO_FILE" | cut -f1)"

      - name: Split ISO if larger than 1.9GB
        id: split
        run: |
          ISO_FILE="${{ steps.iso.outputs.path }}"
          ISO_SIZE="${{ steps.iso.outputs.size }}"
          LIMIT=$((1900 * 1024 * 1024))  # 1.9GB in bytes

          if [ "$ISO_SIZE" -gt "$LIMIT" ]; then
            echo "ISO is $(du -h "$ISO_FILE" | cut -f1) — splitting into 1.9GB parts"
            split -b 1900M -d --additional-suffix=.part "$ISO_FILE" "/tmp/archiso-out/eightone-os-"
            echo "split=true" >> "$GITHUB_OUTPUT"
            ls -lh /tmp/archiso-out/*.part
          else
            echo "ISO is $(du -h "$ISO_FILE" | cut -f1) — no split needed"
            echo "split=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload ISO artifact (unsplit)
        if: steps.split.outputs.split == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.iso.outputs.name }}
          path: |
            ${{ steps.iso.outputs.path }}
            /tmp/archiso-out/*.sha256
          retention-days: 7
          compression-level: 0

      - name: Upload ISO artifact (split parts)
        if: steps.split.outputs.split == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.iso.outputs.name }}-parts
          path: |
            /tmp/archiso-out/*.part
            /tmp/archiso-out/*.sha256
          retention-days: 7
          compression-level: 0

      - name: Prepare release assets
        id: assets
        run: |
          mkdir -p /tmp/release-assets
          cp /tmp/archiso-out/*.sha256 /tmp/release-assets/
          if [ "${{ steps.split.outputs.split }}" = "true" ]; then
            # ISO exceeded 2GB GitHub limit — upload split parts only
            cp /tmp/archiso-out/*.part /tmp/release-assets/
            echo "split_note=**Note:** ISO was split into parts due to GitHub's 2GB asset limit. Download all \`.part\` files and reassemble (see instructions below)." >> "$GITHUB_OUTPUT"
          else
            cp /tmp/archiso-out/*.iso /tmp/release-assets/
            echo "split_note=" >> "$GITHUB_OUTPUT"
          fi
          echo "Release assets:"
          ls -lh /tmp/release-assets/

      - name: Create Release
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'true')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.iso.outputs.date }}
          name: "EIGHT.ONE OS — ${{ steps.iso.outputs.date }}"
          body: |
            ## EIGHT.ONE OS — Infinity One

            **Build Date:** ${{ steps.iso.outputs.date }}
            **Commit:** ${{ github.sha }}
            ${{ steps.assets.outputs.split_note }}

            ### What's included
            - Hyprland Wayland compositor with Matrix-gold premium theme
            - 27 `holy-*` TUI tools (AI, IDE, WiFi, Bluetooth, Flow Timer, etc.)
            - Full developer toolkit (Neovim, VS Code, Git, Docker, Lazygit)
            - AI integration (Ollama, Claude Code, Gemini CLI)
            - TLP battery optimization + zram + earlyoom
            - Flatpak + Brave Browser support

            ### Download Instructions

            **If the ISO was split into parts** (files ending in `.part`):
            ```bash
            # Download all .part files, then reassemble:
            cat eightone-os-*.part > eight-one-os.iso

            # Verify checksum
            sha256sum -c *.sha256
            ```

            **Flash to USB:**
            ```bash
            sudo dd if=eight-one-os.iso of=/dev/sdX bs=4M status=progress oflag=sync
            # Or use: balena-etcher, ventoy, or rufus
            ```

            **Test in QEMU:**
            ```bash
            qemu-system-x86_64 -m 4G -enable-kvm -bios /usr/share/ovmf/OVMF.fd -cdrom eight-one-os.iso
            ```
          files: /tmp/release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
